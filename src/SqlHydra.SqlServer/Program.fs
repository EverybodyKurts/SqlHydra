open SqlHydra
open SqlHydra.SqlServer
open Argu
open Schema

let sqlHydraId  = "SqlHydra.SqlServer"
let command     = "sqlhydra-mssql"
let readerType = "Microsoft.Data.SqlClient.SqlDataReader"
let comment     = $"// This code was generated by {sqlHydraId}."

[<EntryPoint>]
let main argv =

    let cfg = 
        let parser = ArgumentParser.Create<Schema.Arguments>(command)
        let args = parser.Parse(argv)

        { 
            Config.ConnectionString = args.GetResult(Arguments.Connection)
            Config.Namespace = args.GetResult(Arguments.Namespace)
            Config.OutputFile = args.GetResult(Arguments.Output)
            Config.IsCLIMutable = args.Contains(Arguments.CLI_Mutable) 
            Config.Readers = 
                if args.Contains(Arguments.Readers) then
                    {
                        IsEnabled = true
                        ReaderType = args.GetResult(Arguments.Readers) |> Option.defaultValue readerType
                    }
                else
                    { 
                        IsEnabled = false
                        ReaderType = readerType
                    }
        }

    let formattedCode = 
        SqlServerSchemaProvider.getSchema cfg
        |> SchemaGenerator.generateModule cfg
        |> SchemaGenerator.toFormattedCode cfg comment

    System.IO.File.WriteAllText(cfg.OutputFile, formattedCode)
    0
